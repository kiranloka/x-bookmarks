// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String  @id @default(cuid())
  email          String  @unique
  username       String? @unique
  hashedPassword String?

  //X oauth creds 
  xUserId       String?   @unique
  xUserName     String?
  xAccessToken  String?   @db.Text
  xRefreshToken String?   @db.Text
  xTokenExpiry  DateTime?

  bookmarks  Bookmark[]
  Categories Category[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastSyncAt DateTime

  @@map("users")
}

model Bookmark {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  //x Tweet data

  tweetId        String
  tweetUrl       String
  authorUsername String
  authorName     String
  authorAvatar   String?
  tweetText      String   @db.Text
  tweetCreatedAt DateTime

  mediaUrls Json?
  s3Keys    Json?

  categories Category[] @relation("BookmarkCategories")
  tags       Tag[]      @relation("BookmarkTags")
  notes      String     @db.Text

  isArchived   Boolean  @default(false)
  bookmarkedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId, bookmarkedAt])
  @@index([tweetId])
  @@map("bookmarks")
}

model Category {
  id          String  @id @default(cuid())
  name        String
  slug        String
  color       String?
  icon        String?
  description String? @db.Text

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bookmarks Bookmark[] @relation("BookmarkCategories")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, slug])
  @@index([userId])
  @@map("categories")
}

model Tag {
  id        String     @id @default(cuid())
  name      String
  bookmarks Bookmark[] @relation("BookmarkTags")

  createdAt DateTime @default(now())

  @@unique([name])
  @@map("tags")
}

model SyncJob {
  id     String    @id @default(cuid())
  userId String
  status JobStatus @default(PENDING)
  type   SyncType

  startedAt   DateTime?
  completedAt DateTime?
  error       String?   @db.Text

  metadate  Json?
  createdAt DateTime @default(now())

  @@index([userId, status])
  @@map("sync_jobs")
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SyncType {
  FULL_SYNC
  INCREMENTAL_SYNC
  MANUAL_IMPORT
}
